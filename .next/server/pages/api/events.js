"use strict";(()=>{var e={};e.id=174,e.ids=[174],e.modules={8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},2113:e=>{e.exports=require("next-auth/next")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},366:e=>{e.exports=import("kysely")},8678:e=>{e.exports=import("pg")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},9718:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>u,default:()=>c,routeModule:()=>l});var s=a(1802),n=a(7153),i=a(6249),o=a(7157),d=e([o]);o=(d.then?(await d)():d)[0];let c=(0,i.l)(o,"default"),u=(0,i.l)(o,"config"),l=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/events",pathname:"/api/events",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},8323:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{IP:()=>i,oV:()=>o,xC:()=>c,yM:()=>d});var s=a(409),n=e([s]);async function i(){let e=await s.db.selectFrom("events").selectAll().execute(),t=await s.db.selectFrom("accounts").select(["id","firstName","lastName","username"]).execute(),a=await s.db.selectFrom("game").select(["id","title","description"]).execute(),r=await s.db.selectFrom("location").select(["id","address"]).execute(),n=[];for(let s of e){let e=r.find(e=>e.id===s.locationId),i=a.find(e=>e.id===s.gameId),o=t.find(e=>e.id===s.hostId);n.push({...s,author:o?.firstName+" "+o?.lastName,game:i?.title,address:e?.address})}return n}async function o(e){let t=await s.db.selectFrom("events").select(["id","date","hostId","gameId","locationId","title","description"]).where("id","=",e).executeTakeFirstOrThrow(),a=await s.db.selectFrom("accounts").select(["id","firstName","lastName","username"]).where("id","=",t.hostId).executeTakeFirstOrThrow(),r=await s.db.selectFrom("game").select(["id","title","description"]).where("id","=",t.gameId).executeTakeFirstOrThrow(),n=await s.db.selectFrom("location").select(["id","address"]).where("id","=",t.locationId).executeTakeFirstOrThrow();return{...t,author:a,game:r,location:n}}async function d(e){console.log("Creating event with data:",{gameId:e.gameId,hostId:e.hostId,locationId:e.locationId,title:e.title,description:e.description,date:e.date,gameIdType:typeof e.gameId,hostIdType:typeof e.hostId,locationIdType:typeof e.locationId});try{return await s.db.transaction().execute(async t=>{try{return await t.insertInto("events").columns(["gameId","hostId","locationId","title","description","date"]).values({gameId:Number(e.gameId),hostId:Number(e.hostId),locationId:Number(e.locationId),title:e.title,description:e.description,date:e.date}).returning(["id","date","hostId","locationId","gameId","title","description"]).executeTakeFirstOrThrow()}catch(e){throw console.error("Error in transaction:",e),e}})}catch(e){throw console.error("Error creating event:",e),e}}async function c(e){return await s.db.transaction().execute(async t=>await t.deleteFrom("events").where("id","=",e).returning(["id","hostId","date","gameId","locationId","title","description"]).executeTakeFirstOrThrow())}s=(n.then?(await n)():n)[0],r()}catch(e){r(e)}})},409:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{db:()=>d});var s=a(8678),n=a(366),i=e([s,n]);[s,n]=i.then?(await i)():i;let o=new n.PostgresDialect({pool:new s.default.Pool({database:process.env.DB_NAME,host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASS,port:Number(process.env.DB_PORT),max:10})}),d=new n.Kysely({dialect:o});r()}catch(e){r(e)}})},9102:(e,t,a)=>{a.d(t,{_:()=>s});let r=require("@prisma/client"),s=global.prisma||new r.PrismaClient},3515:(e,t,a)=>{a.r(t),a.d(t,{authOptions:()=>u,default:()=>l});var r=a(2113),s=a.n(r);let n=require("next-auth/providers/credentials");var i=a.n(n),o=a(9102),d=a(8432),c=a.n(d);let u={session:{strategy:"jwt",maxAge:2592e3},debug:!1,providers:[i()({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Invalid credentials");let t=await o._.user.findUnique({where:{email:e.email}});if(!t||!t?.password||!await c().compare(e.password,t.password))throw Error("Invalid credentials");return{id:t.id,email:t.email,name:t.name}}})],pages:{signIn:"/auth/signin"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.email=t.email,e.name=t.name),e),session:async({session:e,token:t})=>({...e,user:{...e.user,id:t.id}})},secret:process.env.NEXTAUTH_SECRET},l=s()(u)},7157:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>d});var s=a(8323),n=a(3227),i=a(3515),o=e([s]);async function d(e,t){if("GET"===e.method)return c(e,t);try{let a=await (0,n.getServerSession)(e,t,i.authOptions);if(!a)return t.status(401).json({message:"Unauthorized"});switch(e.method){case"POST":return u(e,t,a);case"DELETE":return l(e,t,a);default:return t.status(405).json({message:"Method not allowed"})}}catch(e){return console.error("Authentication error:",e),t.status(401).json({message:"Authentication failed"})}}async function c(e,t){try{let{id:a}=e.query;if(a&&"string"==typeof a){let e=await (0,s.oV)(parseInt(a));return t.status(200).json(e)}{let e=await (0,s.IP)();return t.status(200).json(e)}}catch(e){return t.status(500).json({message:e.message||"An error occurred"})}}async function u(e,t,a){try{let{title:r,description:n,date:i,gameId:o,locationId:d}=e.body;if(!r||!n||!i||!o||!d)return t.status(400).json({message:"Missing required fields"});let c=a.user.email,u=await fetch(`${process.env.NEXTAUTH_URL}/api/accounts?email=${c}`),l=await u.json();if(!l||!l.id)return t.status(404).json({message:"User account not found"});let m=await (0,s.yM)({title:r,description:n,date:new Date(i),gameId:o,locationId:d,hostId:l.id});return t.status(200).json(m)}catch(e){return console.error("Error creating event:",e),t.status(500).json({message:e.message||"An error occurred while creating the event"})}}async function l(e,t,a){try{let{id:r}=e.query;if(!r||"string"!=typeof r)return t.status(400).json({message:"Missing event ID"});let n=await (0,s.oV)(parseInt(r));if(!n)return t.status(404).json({message:"Event not found"});let i=a.user.email,o=await fetch(`${process.env.NEXTAUTH_URL}/api/accounts?email=${i}`),d=await o.json();if(!d||!d.id)return t.status(404).json({message:"User account not found"});let c=a.user.isAdmin||"admin@gmail.com"===a.user.email;if(console.log("Delete request from user:",i,"isAdmin:",c),n.author.id!==d.id&&!c)return t.status(403).json({message:"Not authorized to delete this event"});return await (0,s.xC)(parseInt(r)),t.status(200).json({message:"Event deleted successfully"})}catch(e){return t.status(500).json({message:e.message||"An error occurred while deleting the event"})}}s=(o.then?(await o)():o)[0],r()}catch(e){r(e)}})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=9718);module.exports=a})();